{% extends 'base.html' %}

{% block content %}
    <h1 class="text-center m-2">Welcome to tweet</h1>

    

    <div class='row m-5'>
        <div class='col-md-4 mx-auto col-10'>
            <form class='form' id="tweet-form" method="POST" action='/create-tweet'>
                {% csrf_token %}
                <input type='hidden' value="/" name='next'>
                <textarea required class="form-control" name='content' placeholder="Tweet"></textarea>
                <button class="btn btn-primary" type='submit'>Submit</button>
            </form>
        </div>
    </div>

    <div id='tweets' class="text-center row">

    </div>

<script>
    const tweetCreateForm = document.getElementById("tweet-form");
    tweetCreateForm.onsubmit = (event) => {
        event.preventDefault();
        const form = event.target;
        const data = new FormData(form)
        const method = form.getAttribute("method")
        const endpoint = form.getAttribute("action")
        const xhr = new XMLHttpRequest()
        const responseType = 'json'
        xhr.open(method , endpoint)
        xhr.setRequestHeader("HTTP_X_REQUESTED_WITH" , "XMLHttpRequest")
        xhr.setRequestHeader("X-Requested-With" , "XMLHttpRequest")
        xhr.onload = () => {
            if(xhr.status === 201) {
                let newTweet = xhr.response
                newTweet = JSON.parse(newTweet)
                console.log(newTweet)
                const newEl = formatTweet(newTweet)
                const og = tweetsContainer.innerHTML
                tweetsContainer.innerHTML = newEl + og
            }
        }
        xhr.onerror = () => {
            alert("error in server");
        }
        xhr.send(data)

    }
    const tweetsContainer = document.getElementById("tweets");
    const loadTweets = (tweetsContainer) => {
        fetch('/tweets').then(response => response.json()).then(r => {
        tweetsContainer.innerHTML = "";
        r.response.map(tweet => tweetsContainer.innerHTML += formatTweet(tweet))
        });
    }
    loadTweets(tweetsContainer);
    const likeBtn = (tweet) => `<button class="btn btn-info mb-2" onclick='handleDidLike(${tweet.id} , ${tweet.likes})'>Like</button>`
    const formatTweet = tweet => `<div style="display: inline-block;" class='rounded m-3 col-12 col-md-3 border bg-dark' id='tweet-${tweet.id}'><h3 class='text-danger'>Tweet ${tweet.id}</h3><p class='text-info m-3'>${tweet.content}<p class='text-success m-3'>likes : ${tweet.likes}<p></p>${likeBtn(tweet)}</div>`
    const tweetElement = document.getElementById('tweets');
    tweetElement.innerHTML = "loading..."


    
</script>
{% endblock content %}